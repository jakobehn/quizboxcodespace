parameters:
  namespace: ''
  kubernetesServiceConnection: ''
  ingressHostName: ''

steps:

- task: KubernetesManifest@0
  name: bake
  displayName: Bake K8s manifests from Helm chart
  inputs:
    action: bake
    kubernetesServiceConnection: ${{ parameters.kubernetesServiceConnection }}      
    helmChart: helm/qbox
    overrides: |
      frontend.image.tag:$(build.buildnumber)
      backend.image.tag:$(build.buildnumber)
      ingress.hostname:${{ parameters.ingressHostName }}

- task: KubernetesManifest@0
  displayName: Deploy to AKS
  inputs:
    action: 'deploy'
    kubernetesServiceConnection: ${{ parameters.kubernetesServiceConnection }}
    namespace: ${{ parameters.namespace }}
    manifests: $(bake.manifestsBundle)
    containers: '$(containerRegistry)/$(imageRepository):$(tag)'