#Deployment pipeline for QBox, deploys latest version of QBox pipeline
trigger: none

resources:
  pipelines:
  - pipeline: QBox
    project: QBox
    source: QBox
    branch: master
    trigger:
      branches:
        include:
        - master    

stages:

- stage: DevTest
  displayName: DevTest  
  variables:
  - group: quizbox-dev

  jobs:    
  - template: deploy-template.yml
    parameters:
      environment: DevTest.qbox
      ingressHostName: $(ingressHostName)
      dbpassword: $(dbpassword)
      trafficManagerEnabled: $(trafficManagerEnabled)
      trafficManagerDNS: $(trafficManagerDNS)
      namespace: $(namespace)
    condition: and(succeeded(), not(startsWith(variables['Build.SourceBranch'], 'refs/pull/')))      

- stage: DevTestPR
  displayName: DevTestPR
  variables:
  - group: quizbox-dev

  jobs:    
  - template: deploy-template.yml
    parameters:
      environment: DevTest.$(k8sNamespaceForPR)
      ingressHostName: $(ingressHostName)
      dbpassword: $(dbpassword)
      trafficManagerEnabled: $(trafficManagerEnabled)
      trafficManagerDNS: $(trafficManagerDNS)
      namespace: $(namespace)
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/pull/'))  

- stage: ProdEU
  displayName: Prod EU
  dependsOn: DevTest
  variables:
  - group: quizbox-prodeu

  jobs:
  - template: deploy-template.yml
    parameters:
      environment: ProdEU.qbox
      ingressHostName: $(ingressHostName)
      dbpassword: $(dbpassword)
      trafficManagerEnabled: $(trafficManagerEnabled)
      trafficManagerDNS: $(trafficManagerDNS)
      namespace: $(namespace)

- stage: ProdUS
  displayName: Prod US
  dependsOn: DevTest
  variables:
  - group: quizbox-produs

  jobs:
  - template: deploy-template.yml
    parameters:
      environment: ProdUS.qbox
      ingressHostName: $(ingressHostName)
      dbpassword: $(dbpassword)
      trafficManagerEnabled: $(trafficManagerEnabled)
      trafficManagerDNS: $(trafficManagerDNS)
      namespace: $(namespace)    